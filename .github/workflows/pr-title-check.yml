name: PR Title Check
on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-title:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Title Format
        shell: bash
        run: |
          title="${{ github.event.pull_request.title }}"
          echo "üîç Checking PR title: '$title'"

          # Fail fast if there is a space before '(' (e.g. "feat (scope): ...")
          if [[ "$title" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)[[:space:]]+\( ]]; then
            echo "‚ùå No space allowed before '(' ‚Äî use 'type(scope): ...'"
            exit 1
          fi

          # Require either "type: desc" or "type(scope): desc"
          re='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9][a-z0-9-]*(,[a-z0-9][a-z0-9-]*)*\))?(!)?: [^ ].+$'
          if [[ "$title" =~ $re ]]; then
            echo "‚úÖ Title matches Conventional Commits"
          else
            echo "‚ùå Invalid title. Use 'type: desc' or 'type(scope): desc'"
            echo "   Examples: 'feat: add X', 'feat(eds-tokens): add build scripts', 'feat(eds-tokens)!: switch pipeline'"
            exit 1
          fi

          # Optional: validate scope(s) if present
          if [[ "$title" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)\(([^\)]+)\) ]]; then
            scope_content="${BASH_REMATCH[2]}"
            echo "üì¶ Scope detected: '$scope_content'"

            valid_scopes=("design-system-docs" "eds-color-palette-generator" "eds-core-react" "eds-data-grid-react" "eds-demo" "eds-icons" "eds-lab-react" "eds-tailwind" "eds-tokens" "eds-tokens-build" "eds-tokens-sync" "eds-utils" "figma-broker" "devcontainer" "github" "build" "deps" "config" "docs")

            IFS=',' read -ra scopes <<< "$scope_content"
            all_valid=true
            for scope in "${scopes[@]}"; do
              # no spaces are expected due to regex, but trim anyway
              scope="$(echo "$scope" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
              found=false
              for vs in "${valid_scopes[@]}"; do [[ "$scope" == "$vs" ]] && found=true && break; done
              if ! $found; then echo "    ‚ùå Invalid scope: '$scope'"; all_valid=false; else echo "    ‚úÖ $scope"; fi
            done
            if ! $all_valid; then
              echo ""
              echo "‚ùå One or more invalid scopes. Valid scopes:"
              printf "  - %s\n" "${valid_scopes[@]}"
              exit 1
            fi
          else
            echo "üì¶ No scope used (optional)"
          fi

          echo "‚úÖ PR title OK"
