name: Checks core-react
# on:
#   workflow_dispatch:
#   pull_request:
#     branches:
#       - develop
#     paths:
#       - 'packages/eds-core-react/**'
#       - 'packages/eds-tokens/**'
#       - 'packages/eds-icons/**'
#   push:
#     branches:
#       - develop
jobs:
  setup:
    uses: equinor/design-system/.github/workflows/setup.yml@develop
    with:
      cacheKey: ${{ github.sha }}-core
    secrets:
      npmToken: ${{ secrets.NPM_TOKEN }}
  test:
    name: Test eds-core-react
    runs-on: ubuntu-latest
    needs: [build-utils]
    steps:
      - name: Get base files
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-utils build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-utils
          key: ${{ github.sha }}-build-utils
      - name: Test eds-core-react
        run: node_modules/.bin/pnpm --filter @equinor/eds-core-react run test
  lint:
    name: Lint packages
    runs-on: ubuntu-latest
    needs: [build-utils]
    steps:
      - name: Get base files
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-utils build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-utils
          key: ${{ github.sha }}-build-utils
      - name: Lint all packages
        run: node_modules/.bin/pnpm run lint ./packages
  types:
    name: Check packages types
    runs-on: ubuntu-latest
    needs: [build-utils]
    steps:
      - name: Get base files
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-utils build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-utils
          key: ${{ github.sha }}-build-utils
      - name: Run type checks in core-react
        run: node_modules/.bin/tsc -p ./packages/eds-core-react
      - name: Run type checks in tokens
        run: node_modules/.bin/tsc -p ./packages/eds-icons
      - name: Run type checks in icons
        run: node_modules/.bin/tsc -p ./packages/eds-tokens
      - name: Run type checks in utils
        run: node_modules/.bin/tsc -p ./packages/eds-utils
  build-tokens:
    name: Build eds-tokens
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Get base files
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Build
        run: node_modules/.bin/pnpm --filter @equinor/eds-tokens run build
      - name: Save build to cache
        uses: actions/cache@v2
        with:
          path: ./packages/eds-tokens
          key: ${{ github.sha }}-build-tokens
  test-utils:
    name: Test eds-utils
    runs-on: ubuntu-latest
    needs: [build-tokens]
    steps:
      - uses: actions/cache@v2
        name: Get base files
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-tokens build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-tokens
          key: ${{ github.sha }}-build-tokens
      - name: Test eds-utils
        run: node_modules/.bin/pnpm --filter @equinor/eds-utils run test
  build-utils:
    name: Build eds-utils
    runs-on: ubuntu-latest
    needs: [test-utils]
    steps:
      - uses: actions/cache@v2
        name: Get base files
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-tokens build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-tokens
          key: ${{ github.sha }}-build-tokens
      - name: Build
        run: node_modules/.bin/pnpm --filter @equinor/eds-utils run build
      - name: Save build to cache
        uses: actions/cache@v2
        with:
          path: ./packages/eds-utils
          key: ${{ github.sha }}-build-utils
  build-icons:
    name: Build eds-icons
    runs-on: ubuntu-latest
    needs: [types, test, lint]
    steps:
      - name: Get base files
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Build
        run: node_modules/.bin/pnpm --filter @equinor/eds-icons run build
      - name: Save build to cache
        uses: actions/cache@v2
        with:
          path: ./packages/eds-icons
          key: ${{ github.sha }}-build-icons
  build-core-react:
    name: Build eds-core-react
    runs-on: ubuntu-latest
    needs: [build-icons, build-tokens, build-utils]
    steps:
      - uses: actions/cache@v2
        name: Get base files
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-utils build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-utils
          key: ${{ github.sha }}-build-utils
      - name: Get eds-icons build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-icons
          key: ${{ github.sha }}-build-icons
      - name: Get eds-tokens build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-tokens
          key: ${{ github.sha }}-build-tokens
      - name: Build
        run: node_modules/.bin/pnpm --filter @equinor/eds-core-react run build
      - name: Save build to cache
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-build-core-react
  build-storybook:
    name: Build Storybook
    runs-on: ubuntu-latest
    needs: [test, lint, build-utils]
    steps:
      - name: Get base files
        uses: actions/cache@v2
        with:
          path: |
            ./*
            ~/.pnpm-store
          key: ${{ github.sha }}-core
      - name: Get eds-utils build
        uses: actions/cache@v2
        with:
          path: ./packages/eds-utils
          key: ${{ github.sha }}-build-utils
      - name: Build storybook
        run: node_modules/.bin/pnpm --filter @equinor/eds-core-react run build:storybook
